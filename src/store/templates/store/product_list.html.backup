{% extends 'store/base.html' %}
{% load store_extras %}

{% block title %}
{% if selected_subcategory %}
{{ selected_subcategory.name }} - Nice-Price
{% elif selected_category %}
{{ selected_category.name }} - Nice-Price
{% else %}
Всі товари - Nice-Price
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .sidebar {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e9e9e9;
    }

    .sidebar h3 {
        margin-bottom: 10px;
        font-size: 16px;
        color: #333;
    }

    .filter-group {
        margin-bottom: 16px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: #555;
    }

    .filter-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 13px;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
    }

    .product-card {
        background: #fff;
        border-radius: 8px;
        padding: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #e0e0e0;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .product-card h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 16px;
        line-height: 1.4;
        height: 44px;
        overflow: hidden;
    }

    .product-card .category {
        color: #757575;
        font-size: 12px;
        margin-bottom: 5px;
    }

    .product-card .price-container {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin: 10px 0;
    }

    .product-card .original-price {
        font-size: 14px;
        color: #999;
        text-decoration: line-through;
    }

    .product-card .sale-price {
        font-size: 24px;
        font-weight: bold;
        color: #f84147;
    }

    .product-card .regular-price {
        font-size: 24px;
        font-weight: bold;
        color: #333;
    }

    .discount-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #f84147;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 12px;
    }

    .product-card .stock {
        font-size: 12px;
        margin-bottom: 10px;
    }

    .product-card .stock.in-stock {
        color: #00a046;
    }

    .product-card .stock.out-of-stock {
        color: #f84147;
    }

    .product-card .buttons-container {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }

    .btn-buy {
        display: inline-block;
        background: #007bff;
        /* Blue */
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
        font-size: 14px;
        transition: background 0.2s;
    }

    .btn-buy:hover {
        background: #0056b3;
    }

    .categories-nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .category-link {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
    }

    .category-link:hover,
    .category-link.active {
        background: #f5f5f5;
        color: #007bff;
    }

    .subcategory-list {
        padding-left: 12px;
        margin-top: 4px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .subcategory-link {
        font-size: 13px;
        text-decoration: none;
        color: #666;
    }

    .subcategory-link:hover,
    .subcategory-link.active {
        color: #007bff;
    }

    @media (max-width: 900px) {
        .layout {
            grid-template-columns: 1fr;
        }

        .sidebar {
            display: none;
            /* Hide sidebar on mobile for now */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="layout">
    <aside class="sidebar">
        <form method="get">
            <div class="filter-group">
                <h3>Категорії</h3>
                <div class="categories-nav">
                    {% for category in root_categories %}
                    <div>
                        <a href="?category={{ category.slug }}"
                            class="category-link {% if selected_category == category %}active{% endif %}">
                            <span>{{ category.name }}</span>
                        </a>
                        {% if category.subcategories.all %}
                        <div class="subcategory-list">
                            {% for sub in category.subcategories.all %}
                            <a href="?category={{ category.slug }}&subcategory={{ sub.slug }}"
                                class="subcategory-link {% if selected_subcategory == sub %}active{% endif %}">
                                {{ sub.name }}
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-group">
                <h3>Ціна, грн</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="number" name="min_price" value="{{ min_price|default:'' }}" placeholder="Від">
                    <input type="number" name="max_price" value="{{ max_price|default:'' }}" placeholder="До">
                </div>
            </div>

            <button type="submit" class="btn-green"
                style="width:100%; margin-top:10px; background-color: #007bff;">Застосувати</button>
        </form>
    </aside>

    <div>
        {% if selected_subcategory %}
        <h2 style="margin-bottom: 20px; color: #333;">
            {{ selected_category.name }} / {{ selected_subcategory.name }}
        </h2>
        {% elif selected_category %}
        <h2 style="margin-bottom: 20px; color: #333;">
            Категорія: {{ selected_category.name }}
        </h2>
        {% else %}
        <h2 style="margin-bottom: 20px; color: #333;">Всі товари</h2>
        {% endif %}

        <!-- Sorting -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; align-items: center; gap: 10px;">
            <label for="sort-select" style="font-size: 14px; color: #555;">Сортування:</label>
            <select id="sort-select" onchange="updateSort(this.value)"
                style="padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="price_asc" {% if current_sort=='price_asc' %}selected{% endif %}>Від дешевих до дорогих
                </option>
                <option value="price_desc" {% if current_sort=='price_desc' %}selected{% endif %}>Від дорогих до дешевих
                </option>
                <option value="new" {% if current_sort=='new' %}selected{% endif %}>Новинки</option>
            </select>
        </div>

        {% if products %}
        <div class="products-grid">
            {% for product in products %}
            <div class="product-card">
                {% if product.has_discount %}
                <div class="discount-badge">-{{ product.get_discount_percentage }}%</div>
                {% endif %}

                {% if product.image %}
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}"
                        style="max-width: 100%; max-height: 150px; object-fit: contain;">
                </div>
                {% else %}
                <div
                    style="text-align: center; margin-bottom: 10px; padding: 30px; background-color: {{ product.category.name|get_category_placeholder_color }}; border-radius: 8px;">
                    <i class="fas {{ product.category.name|get_category_placeholder_icon }}"
                        style="font-size: 60px; color: white; opacity: 0.7;"></i>
                </div>
                {% endif %}

                <div class="category">{{ product.category.name }}</div>
                <h3><a href="{% url 'product_detail' product.id %}" style="text-decoration: none; color: inherit;">{{
                        product.name }}</a></h3>
                <div class="price-container">
                    {% if product.has_discount %}
                    <div class="original-price">{{ product.price|floatformat:0 }} ₴</div>
                    <div class="sale-price">{{ product.sale_price|floatformat:0 }} ₴</div>
                    {% else %}
                    <div class="regular-price">{{ product.price|floatformat:0 }} ₴</div>
                    {% endif %}
                </div>
                <div class="stock {% if product.stock > 0 %}in-stock{% else %}out-of-stock{% endif %}">
                    {% if product.stock > 0 %}
                    В наявності
                    {% else %}
                    Немає в наявності
                    {% endif %}
                </div>
                <div class="buttons-container">
                    <a href="{% url 'product_detail' product.id %}" class="btn-buy">
                        <i class="fas fa-shopping-cart"></i> Купити
                    </a>
                    <form method="post" action="{% url 'toggle_favorite' product.id %}"
                        onsubmit="return handleFavoriteSubmit(event);">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit"
                            style="background:none;border:none;cursor:pointer;font-size:24px;color:{% if favorite_ids and product.id in favorite_ids %}#f84147{% else %}#ccc{% endif %};"
                            title="В обране">
                            <i
                                class="{% if favorite_ids and product.id in favorite_ids %}fas{% else %}far{% endif %} fa-heart"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: #666; margin-top: 30px;">Товари не знайдено.
        </p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const isAuthenticated = {{ user.is_authenticated| lower }};

    function handleFavoriteSubmit(e) {
        if (!isAuthenticated) {
            e.preventDefault();
            alert('Будь ласка, увійдіть або зареєструйтесь, щоб додавати товари в обране.');
            window.location.href = "{% url 'login' %}?next={{ request.path }}";
            return false;
        }
        return true;
    }

    function updateSort(sortValue) {
        const url = new URL(window.location.href);
        url.searchParams.set('sort', sortValue);
        window.location.href = url.toString();
    }
</script>
{% endblock %}